<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/ticketing.css" />
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <title>Ticketing</title>
    <style>
        @import url('https://webfontworld.github.io/pretendard/Pretendard.css');

        body {
            font-family: 'Pretendard', sans-serif;
        }
    </style>
</head>

<body>
    <button id="backToLogin" class="back-button">&times;</button>
    <h1 class="centered-text" id="welcomeMessage"></h1>
    <h1 class="centered-text">좌석 선택</h1>
    <div class="stage">
        <div class="stage-text">
            <div class="stage-text-inner">
                Stage
            </div>
        </div>
    </div>
    <div class="squares_up">
        <div id="squares">
            <div id="seat_left">
                <div class="firstline">
                    <div class="n" id="n"></div>
                    <div class="n" id="n"></div>
                    <div class="n" id="n"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                </div>
                <div class="firstline">
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                </div>
                <div id="l">
                    <div class="square" id="A0">A0</div>
                    <div class="square" id="A1">A1</div>
                    <div class="square" id="A2">A2</div>
                    <div class="square" id="A3">A3</div>
                    <div class="square" id="A4">A4</div>
                    <div class="square" id="A5">A5</div>
                </div>
                <div id="l">
                    <div class="square" id="B0">B0</div>
                    <div class="square" id="B1">B1</div>
                    <div class="square" id="B2">B2</div>
                    <div class="square" id="B3">B3</div>
                    <div class="square" id="B4">B4</div>
                    <div class="square" id="B5">B5</div>
                </div>
                <!-- (중간 생략) -->
            </div>
            <div id="seat_right">
                <div class="firstline">
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                </div>
                <div class="firstline">
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                    <div class="occupied" id="o"></div>
                </div>
                <div id="r">
                    <div class="square" id="A6">A6</div>
                    <div class="square" id="A7">A7</div>
                    <div class="square" id="A8">A8</div>
                    <div class="square" id="A9">A9</div>
                    <div class="square" id="A10">A10</div>
                    <div class="square" id="A11">A11</div>
                </div>
                <!-- (중간 생략) -->
            </div>
        </div>
    </div>

    <script>
        const serverURL = 'http://localhost:3000'; // 서버 URL 설정

        let selectedSquareId = null; // 선택된 좌석 ID안

        document.addEventListener('DOMContentLoaded', () => {
            updateSquares();

            document.querySelectorAll('.square').forEach(square => {
                square.addEventListener('click', () => {
                    // 이미 선택된 좌석이 있는 경우 추가 선택을 막음
                    if (selectedSquareId) {
                        alert('이미 선택된 좌석이 있습니다. 선택을 취소한 후 다시 시도하세요.');
                        return;
                    }

                    const squareId = square.id;
                    fetch(`${serverURL}/get-selected-squares`)
                        .then(res => res.json())
                        .then(data => {
                            if (data[squareId]) {
                                if (data[squareId].isOwner) {
                                    window.location.href = `/seat-info.html?seatId=${squareId}&name=${data[squareId].name}`;
                                } else {
                                    alert('이미 선택된 좌석입니다.');
                                }
                            } else {
                                selectedSquareId = squareId; // 선택된 좌석 ID 저장
                                window.location.href = `/ticket/${selectedSquareId}`;
                            }
                        });
                });
            });
        });

        function updateSquares() {
            fetch(`${serverURL}/get-selected-squares`)
                .then(res => res.json())
                .then(data => {
                    for (let squareId in data) {
                        const square = document.getElementById(squareId);
                        if (data[squareId].isOwner) {
                            square.style.backgroundColor = '#90EE90'; // 밝은 초록색
                        } else {
                            square.classList.add('disabled');
                        }
                    }
                });
        }

        // 쿠키 값 읽기 함수
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        }

        // 페이지 로드 시 사용자 이름을 표시
        const userName = getCookie('userName');
        const welcomeMessage = document.getElementById('welcomeMessage');
        welcomeMessage.textContent = userName ? `${userName}님, 환영합니다!` : '환영합니다!';

        // 뒤로가기 버튼 기능 추가
        document.getElementById('backToLogin').addEventListener('click', function () {
            if (confirm('로그인 페이지로 돌아가시겠습니까?')) {
                window.location.href = '/login.html';
            }
        });
    </script>
</body>

</html>
